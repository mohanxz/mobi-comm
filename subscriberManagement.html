<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobi-Comm Dashboard</title>
    <link rel="stylesheet" href="css/adminDashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>




</head>

<body class="bg-light">

    <aside class="d-none d-md-block">
        <div class="container" style="margin-left: -30px;">
            <img src="src/images/mobi-comm-named-logo-removebg-preview.png" alt="" style="width: 200px;">

        </div>
        <nav class="mt-3">
            <ul class="list-unstyled">
                <li class="p-2   rounded mb-2">
                    <a href="http://127.0.0.1:5501/AdminDashboard.html#" class="text-dark text-decoration-none">Expiring Recharges</a>
                </li>
                <li class="p-2 text-dark bg-danger   rounded mb-2">
                    <a href="http://127.0.0.1:5501/subscriberManagement.html" class=" text-white text-decoration-none">Subscribers</a>
                </li>
                <li class="p-2 text-dark rounded mb-2">
                    <a href="#" class="text-dark text-decoration-none">Recharge Management</a>
                </li>
                <li class="p-2 text-dark rounded mb-2">
                    <a href="#" class="text-dark text-decoration-none">Complaint Management</a>
                </li>
                <li class="p-2 text-dark rounded mb-2">
                    <a href="#" class="text-dark text-decoration-none">Admin Controls</a>
                </li>
            </ul>
        </nav>
        
    </aside>

    <!-- Offcanvas Sidebar for Mobile -->
    <button class="btn btn-danger d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
        ☰ Menu
    </button>

    <div class="offcanvas offcanvas-start d-md-none" id="mobileSidebar">
        <div class="offcanvas-header">
            <h5 class="text-danger fw-bold">MOBI-COMM</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <nav>
                <ul class="list-unstyled">
                    <li class="p-2 bg-primary text-white rounded mb-2">Expiring Recharges</li>
                    <li class="p-2 text-dark rounded mb-2">Subscribers</li>
                    <li class="p-2 text-dark rounded mb-2">Recharge Management</li>
                    <li class="p-2 text-dark rounded mb-2">Complaint Management</li>
                    <li class="p-2 text-dark rounded mb-2">Admin Controls</li>
                </ul>
            </nav>
        </div>
    </div>
    <!-- Main Content -->
    <main class="flex-grow-1 p-4">

        <div class="container mb-0">
            <div class="row mb-0">
                <div class="col">
                    <div class=" text-secondary p-4 rounded  fs-3 fw-semibold fade-in">
                        Welcome,Admin!
                    </div>

                </div>
                <div class="col mt-2 ms-5">

                    <div class="container " id="clock">
                        <div class="display-date mt-4 ms-5 ">
                            <span id="day">day</span>,
                            <span id="daynum">00</span>
                            <span id="month">month</span>
                            <span id="year">0000</span>
                        </div>
                        <div class="display-time d-inline ms-1"></div>
                    </div>


                </div>
                <img src="src/images/mobi-comm-logo-removebg-preview.png" class="ms-3" id="mobiLogo" alt="">

            </div>
        </div>


       

    <script src="JavaScript/expirationChart.js"> </script>

    <script>
        async function fetchUserData() {
            try {
                const response = await fetch("http://localhost:3000/users");
                const users = await response.json();
                generateCharts(users);
            } catch (error) {
                console.error("Error fetching user data:", error);
            }
        }

        function generateCharts(users) {
            // 1️⃣ Churn Rate (Pie Chart)
            const churnedUsers = users.filter(user => !user.active).length;
            const activeUsers = users.length - churnedUsers;
            new Chart(document.getElementById("churnRateChart"), {
                type: "pie",
                data: {
                    labels: ["Active", "Churned"],
                    datasets: [{
                        data: [activeUsers, churnedUsers],
                        backgroundColor: ["#4CAF50", "#FF5733"]
                    }]
                }
            });

            // 2️⃣ Plan Distribution (Bar Chart)
            const planCounts = users.reduce((acc, user) => {
                acc[user.currentPlan] = (acc[user.currentPlan] || 0) + 1;
                return acc;
            }, {});
            new Chart(document.getElementById("planChart"), {
                type: "bar",
                data: {
                    labels: Object.keys(planCounts),
                    datasets: [{
                        label: "Users per Plan",
                        data: Object.values(planCounts),
                        backgroundColor: "#4285F4"
                    }]
                }
            });

            // 3️⃣ Expiration & Retention (Line Chart)
            const expiringUsers = users.map(user => ({
                username: user.username,
                expiryDate: user.rechargeHistory[0]?.expiryDate || "N/A"
            })).sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            new Chart(document.getElementById("expirationChart"), {
                type: "line",
                data: {
                    labels: expiringUsers.map(user => user.username),
                    datasets: [{
                        label: "Expiration Dates",
                        data: expiringUsers.map((_, i) => i + 1),
                        borderColor: "#FF9800",
                        fill: false
                    }]
                }
            });

            // 4️⃣ Wallet Amount Stats (Doughnut Chart)
            const totalWalletAmount = users.reduce((sum, user) => sum + user.walletAmount, 0);
            new Chart(document.getElementById("walletChart"), {
                type: "doughnut",
                data: {
                    labels: ["Total Wallet Amount"],
                    datasets: [{
                        data: [totalWalletAmount],
                        backgroundColor: ["#8E44AD"]
                    }]
                }
            });
        }

        fetchUserData();



    </script>




    <script src="JavaScript/adminHomepage.js"></script>
    <script src="JavaScript/filter.js"></script>
    <script src="JavaScript/expirationChart.js"></script>
</body>

</html>