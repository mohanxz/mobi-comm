<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Plan Management</title>
    <link rel="stylesheet" href="css/mainmin.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/adminDashboard.css">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body{
            overflow-x: hidden;
        }
        .tabs {
            display: flex;
            background: #fff;
            border-radius: 50px;
            padding: 10px;
            position: relative;
            left: 110px;
            box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px 13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset;


        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            
        }

        .tab.active {
            font-weight: bold;
            color: #d52136;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #main-content{
            width:75% !important;
        }
        /* Ensure main content takes up remaining space */
#main-content {
    margin-inline:140px;
    width: calc(100% - 90px);
}

/* Sidebar styles */
aside {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 250px;
    background: #f8f9fa;
    padding: 15px;
    overflow-y: auto;
    border-right: 1px solid #ddd;
}

/* Ensure cards adjust properly */
.plan-card {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: 0.3s;
    margin: 30px;
}

.plan-card:hover {
    transform: translateY(-5px);
}

.plan-buttons {
    display: flex;
    gap: 10px;
}

.input{
    position: relative;
    left: 130px;
    

}

#header{
    position: relative;
    left: 100px;
    color: #d52136;
}

@media(min-width:700px){
    #main-content{
        position: relative;
        left: 100px;
    }
    .tabs{
        position: relative;
        width:80%;
    }
}


@media(max-width:600px){
    #navBtn{
        height: 40px;
    }
    #main-content{
        position: relative;
        left: -220px;
        top: 50px;
    }
    .tabs{
        width: 430px;
        position: relative;
    }
}
    </style>
</head>

    <body class="container-fluid mt-4">
        <div class="d-flex">
            <!-- Sidebar -->
            <aside class="d-none d-md-block bg-light p-3" style="width: 250px; min-height: 100vh;">
                <div class="text-center">
                    <img src="src/images/mobi-comm-named-logo-removebg-preview.png" alt="" style="width: 180px;">
                </div>
                <nav class="mt-3">
                    <ul class="list-unstyled">
                        <li class="p-2 rounded mb-2">
                            <a href="#" class="text-dark text-decoration-none">Expiring Recharges</a>
                        </li>
                        <li class="p-2   rounded mb-2">
                            <a href="http://127.0.0.1:5501/subscriberManagement.html" class="text-dark text-decoration-none">Subscribers</a>
                        </li>
                        <li class="p-2 rounded mb-2 bg-danger">
                            <a href="#" class="text-light text-decoration-none">Plans</a>
                        </li>
                        <li class="p-2 rounded mb-2">
                            <a href="http://127.0.0.1:5501/RechargeManagement.html#" class="text-dark text-decoration-none">Recharge Management</a>
                        </li>
                        <li class="p-2 rounded mb-2">
                            <a href="#" class="text-dark text-decoration-none">Complaint Management</a>
                        </li>
                    </ul>
                </nav>
            </aside>
            <button class="btn btn-danger d-md-none" type="button" id="navBtn" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
                ☰ Menu
            </button>
            
            <div class="offcanvas offcanvas-start d-md-none" id="mobileSidebar">
                <div class="offcanvas-header">
                    <h5 class="text-danger fw-bold">MOBI-COMM</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
                </div>
                <div class="offcanvas-body">
                    <nav>
                        <ul class="list-unstyled">
                            <li class="p-2 bg-danger text-white rounded mb-2">
                                <a href="http://127.0.0.1:5501/AdminDashboard.html" class="text-white text-decoration-none">Expiring Recharges</a>
                            </li>
                            <li class="p-2 text-dark rounded mb-2">
                                <a href="http://127.0.0.1:5501/subscriberManagement.html" class="text-dark text-decoration-none">Subscribers</a>
                            </li>
                            <li class="p-2 text-dark rounded mb-2">
                                <a href="http://127.0.0.1:5501/planManagement.html" class="text-dark text-decoration-none">Plans</a>
                            </li>
                            <li class="p-2 text-dark rounded mb-2">
                                <a href="#" class="text-dark text-decoration-none">Complaint Management</a>
                            </li>
                            <li class="p-2 text-dark rounded mb-2">
                                <a href="#" class="text-dark text-decoration-none">Admin Controls</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            
            
    
            <!-- Main Content -->
            <div id="main-content" class="flex-grow-1 p-3">
                <h1 class="mb-3 ms-5" id="header">Admin Plan Management</h1>
    
                <!-- Tabs -->
                <div class="tabs ms-5">
                    <div class="tab active" data-category="recommended">Recommended</div>
                    <div class="tab" data-category="validity">Validity</div>
                    <div class="tab" data-category="data">Data</div>
                    <div class="tab" data-category="unlimited">Unlimited 5G</div>
                    <div class="tab" data-category="ott">OTT</div>
                </div>

                <div class="input">

                    <input type="text" id="searchBar" class="form-control ms-5 mt-5 d-inline input-style py-3 pe-5" 
        placeholder=" Search plans..." style="width: 300px;"><i class="fas fa-search text-"></i>
        <button class="btn  ms-5 d-inline add-btn text-light" id="addPlanBtn">➕ Add New Plan</button>
    
        
                </div>
    
                <!-- Plans Container -->
                <div id="plansContainer" class="row gx-1  mt-3"></div>
            </div>
        </div>
        <div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPlanModalLabel">Add New Plan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addPlanForm">
                            <div class="mb-3">
                                <label for="planLabel" class="form-label">Plan Label</label>
                                <input type="text" class="form-control" id="planLabel" required>
                            </div>
                            <div class="mb-3">
                                <label for="planName" class="form-label">Plan Name</label>
                                <input type="text" class="form-control" id="planName" required>
                            </div>
                            <div class="mb-3">
                                <label for="planCode" class="form-label">Plan Code</label>
                                <input type="text" class="form-control" id="planCode" required>
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="price" required>
                            </div>
                            <div class="mb-3">
                                <label for="validityDays" class="form-label">Validity (Days)</label>
                                <input type="number" class="form-control" id="validityDays" required>
                            </div>
                            <div class="mb-3">
                                <label for="dataLimit" class="form-label">Data Limit</label>
                                <input type="text" class="form-control" id="dataLimit" required>
                            </div>
                            <div class="mb-3">
                                <label for="dataRollover" class="form-label">Data Rollover</label>
                                <input type="text" class="form-control" id="dataRollover">
                            </div>
                            <div class="mb-3">
                                <label for="callLimit" class="form-label">Call Limit</label>
                                <input type="text" class="form-control" id="callLimit" required>
                            </div>
                            <div class="mb-3">
                                <label for="smsLimit" class="form-label">SMS Limit</label>
                                <input type="text" class="form-control" id="smsLimit">
                            </div>
                            <div class="mb-3">
                                <label for="categoryId" class="form-label">Category</label>
                                <select class="form-control" id="categoryId" required>
                                    <option value="">Loading categories...</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="savePlanBtn">Save Plan</button>
                    </div>
                </div>
            </div>
        </div>

     
        <div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Plan</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label for="editPlanLabel">Plan Label:</label>
                        <input type="text" id="editPlanLabel" class="form-control">
        
                        <label for="editPlanName">Plan Name:</label>
                        <input type="text" id="editPlanName" class="form-control">
        
                        <label for="editPlanCode">Plan Code:</label>
                        <input type="text" id="editPlanCode" class="form-control">
        
                        <label for="editPrice">Price:</label>
                        <input type="number" id="editPrice" class="form-control">
        
                        <label for="editValidityDays">Validity (Days):</label>
                        <input type="number" id="editValidityDays" class="form-control">
        
                        <label for="editDataLimit">Data Limit:</label>
                        <input type="text" id="editDataLimit" class="form-control">
        
                        <label for="editDataRollover">Data Rollover:</label>
                        <input type="text" id="editDataRollover" class="form-control">
        
                        <label for="editCallLimit">Call Limit:</label>
                        <input type="text" id="editCallLimit" class="form-control">
        
                        <label for="editSmsLimit">SMS Limit:</label>
                        <input type="text" id="editSmsLimit" class="form-control">
        
                        <label for="editPlanBadge">Select Plan Badge:</label>
                        <select id="editPlanBadge" class="form-control">
                            <option value="none" selected>None</option>
                            <option value="src/images/best-seller-banner_175838-470-removebg-preview.png">Best Seller</option>
                            <option value="src/images/special-offer-creative-sale-banner-design.png">Budget Friendly</option>
                            <option value="img3.png">Most Popular</option>
                            <option value="img4.png">Limited Offer</option>
                        </select>
        
                        <div class="mt-3 text-center">
                            <img id="editBadgePreview" src="" style="display:none; width: 50px; height: 50px;">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveEditedPlan">Save Plan</button>
                    </div>
                </div>
            </div>
        </div>
    

    
</body>
    
    <!-- Tabs -->
    
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

 <script>
  document.addEventListener("DOMContentLoaded", function () {
    const categoryEndpoint = "http://localhost:8081/api/categories";
    const plansBaseEndpoint = "http://localhost:8081/api/plans/category/";
    const planEndpoint = "http://localhost:8081/api/plans";

    let currentCategory = "";

    function normalizeCategoryName(name) {
      return name.toLowerCase().replace(/_/g, "");
    }
    
    function formatValidity(validityDays) {
            if (!validityDays || isNaN(validityDays)) return ""; 
    
            const validityMap = {
                1: "1 Day",
                2: "2 Days",
                3: "3 Days",
                5: "5 Days",
                7: "1 Week",
                10: "10 Days",
                14: "2 Weeks",
                15: "15 Days",
                21: "3 Weeks",
                28: "4 Weeks",
                30: "1 Month",
                45: "1.5 Months",
                60: "2 Months",
                75: "2.5 Months",
                90: "3 Months",
                120: "4 Months",
                150: "5 Months",
                180: "6 Months",
                270: "9 Months",
                300: "10 Months",
                330: "11 Months",
                365: "1 Year",
                730: "2 Years",
                1095: "3 Years"
            };
    
            if (validityMap[validityDays]) {
                return validityMap[validityDays];
            }
    
            if (validityDays % 365 === 0) {
                return `${validityDays / 365} Years`;
            } 
            if (validityDays % 30 === 0) {
                return `${validityDays / 30} Months`;
            } 
            if (validityDays % 7 === 0) {
                return `${validityDays / 7} Weeks`;
            }
    
            return `${validityDays} Days`;
        }
    
        function formatPriceWithValidity(price, validityDays) {
            const formattedValidity = formatValidity(validityDays);
            return formattedValidity ? `₹${price} / ${formattedValidity}` : `₹${price}`;
        }

    function loadCategories() {
      fetch(categoryEndpoint)
        .then(response => response.json())
        .then(categories => {
          let tabsContainer = document.querySelector(".tabs");
          tabsContainer.innerHTML = "";

          categories.sort((a, b) => {
            if (a.categoryName.toLowerCase() === "recommended") return -1;
            if (b.categoryName.toLowerCase() === "recommended") return 1;

            const priorityKeywords = ["validity", "data", "unlimited", "ott plans"];
            const aPriority = priorityKeywords.some(keyword => a.categoryName.toLowerCase().includes(keyword));
            const bPriority = priorityKeywords.some(keyword => b.categoryName.toLowerCase().includes(keyword));

            if (aPriority && !bPriority) return -1;
            if (bPriority && !aPriority) return 1;

            return a.categoryId - b.categoryId;
          });

          categories.forEach(category => {
            let categoryName = normalizeCategoryName(category.categoryName);

            let tab = document.createElement("div");
            tab.classList.add("tab");
            tab.dataset.category = categoryName;
            tab.textContent = category.categoryName;
            tab.addEventListener("click", function () {
              document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
              this.classList.add("active");
              currentCategory = categoryName;
              loadAdminPlans();
            });

            tabsContainer.appendChild(tab);

            if (!currentCategory) {
              currentCategory = categoryName;
            }
          });

          document.querySelector(".tab").classList.add("active");
          loadAdminPlans();
        })
        .catch(error => console.error("Error loading categories:", error));
    }

    function loadAdminPlans() {
      if (!currentCategory) return;

      fetch(`${plansBaseEndpoint}${currentCategory}`)
        .then(response => response.json())
        .then(plans => {
          const container = document.getElementById("plansContainer");
          container.innerHTML = "";

          plans.forEach(plan => {
            let featuresList = [];
            if (plan.callLimit) featuresList.push(`<li>${plan.callLimit}</li>`);
            if (plan.dataLimit) featuresList.push(`<li>${plan.dataLimit}</li>`);
            if (plan.smsLimit) featuresList.push(`<li>${plan.smsLimit}</li>`);
            if (plan.dataRollover && plan.dataRollover.toLowerCase() !== "none") featuresList.push(`<li>${plan.dataRollover}</li>`);
            if (plan.ottPlans) featuresList.push(`<li>${plan.ottPlans}</li>`);

            let badgeHtml = plan.imagePath ? `<img src="${plan.imagePath}" class="plan-img" style="width:100%; height:150px; object-fit:cover;">` : "";

            let isActive = plan.isActive;

            let planCard = `
              <div class="col-lg-4 col-sm-6">
                <div class="plan-card mx-5 position-relative ${isActive ? '' : 'bg-light'}">
                  ${badgeHtml}
                  <div class="plan-header">${plan.planLabel || ""} ${isActive ? "" : "(Hidden)"}</div>
                  <h5 class="plan-title">${plan.planName} - ₹${plan.price}</h5>
               <p class="plan-price">${formatPriceWithValidity(plan.price+"", plan.validityDays)}</p>
                  <ul class="plan-features">${featuresList.join("")}</ul>
                  <div class="plan-buttons">
                    <button class="btn toggle-hide text-light" data-id="${plan.planId}" data-isActive="${isActive}">
                      ${isActive ? '<i class="fa-solid fa-eye-slash"></i> Hide' : '<i class="fa-solid fa-eye"></i> Unhide'}
                    </button>
                    <button class="btn edit-plan text-light" data-id="${plan.planId}"><i class="fas fa-edit"></i> Edit</button>
                  </div>
                </div>
              </div>`;

            container.innerHTML += planCard;
          });
        })
        .catch(error => console.error("Error loading plans:", error));
    }
    document.addEventListener("click", function (event) {
    if (event.target.closest(".toggle-hide")) {
        let button = event.target.closest(".toggle-hide");
        let planId = button.dataset.id;
        let isActive = button.dataset.isActive === "true";

        fetch(`${planEndpoint}/${planId}`)
            .then(response => response.json())
            .then(plan => {
                plan.isActive = !isActive;

                return fetch(`${planEndpoint}/${planId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(plan)
                });
            })
            .then(() => {
                button.dataset.isActive = !isActive;
                button.innerHTML = !isActive
                    ? '<i class="fa-solid fa-eye-slash"></i> Hide'
                    : '<i class="fa-solid fa-eye"></i> Unhide';

                button.closest(".plan-card").classList.toggle("bg-light", !isActive);
            })
            .catch(error => console.error("Error updating plan visibility:", error));
    }
});
    document.addEventListener("click", function (event) {
        if (event.target.closest(".edit-plan")) {
            let planId = event.target.closest(".edit-plan").dataset.id;

            fetch(`${planEndpoint}/${planId}`)
                .then(response => response.json())
                .then(plan => {
                    document.getElementById("editPlanLabel").value = plan.planLabel || "";
                    document.getElementById("editPlanName").value = plan.planName || "";
                    document.getElementById("editPlanCode").value = plan.planCode || "";
                    document.getElementById("editPrice").value = plan.price || "";
                    document.getElementById("editValidityDays").value = plan.validityDays || "";
                    document.getElementById("editDataLimit").value = plan.dataLimit || "";
                    document.getElementById("editDataRollover").value = plan.dataRollover || "";
                    document.getElementById("editCallLimit").value = plan.callLimit || "";
                    document.getElementById("editSmsLimit").value = plan.smsLimit || "";
                    document.getElementById("editPlanBadge").value = plan.imagePath || "";

                    // Store plan ID for update
                    document.getElementById("saveEditedPlan").dataset.id = plan.planId;

                    // Open Modal
                    $("#editPlanModal").modal("show");
                })
                .catch(error => console.error("Error fetching plan:", error));
        }
    });

    // Event Listener for Saving Edited Plan
    document.getElementById("saveEditedPlan").addEventListener("click", function () {
        let planId = this.dataset.id;

        fetch(`${planEndpoint}/${planId}`)
            .then(response => response.json())
            .then(existingPlan => {
                let updatedPlan = {
                    planLabel: document.getElementById("editPlanLabel").value.trim() || existingPlan.planLabel,
                    planName: document.getElementById("editPlanName").value.trim() || existingPlan.planName,
                    planCode: document.getElementById("editPlanCode").value.trim() || existingPlan.planCode,
                    price: parseFloat(document.getElementById("editPrice").value.trim()) || existingPlan.price,
                    validityDays: parseInt(document.getElementById("editValidityDays").value.trim()) || existingPlan.validityDays,
                    dataLimit: document.getElementById("editDataLimit").value.trim() || existingPlan.dataLimit,
                    dataRollover: document.getElementById("editDataRollover").value.trim() || existingPlan.dataRollover,
                    callLimit: document.getElementById("editCallLimit").value.trim() || existingPlan.callLimit,
                    smsLimit: document.getElementById("editSmsLimit").value.trim() || existingPlan.smsLimit,
                    imagePath: document.getElementById("editPlanBadge").value.trim() || existingPlan.imagePath,
                    isActive: true, 
                    categoryId: existingPlan.categoryId // Retain existing category
                };

                return fetch(`${planEndpoint}/${planId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updatedPlan)
                });
            })
            .then(() => {
                $("#editPlanModal").modal("hide"); // Close modal
                loadAdminPlans(); // Reload plans
            })
            .catch(error => console.error("Error updating plan:", error));
    });


    
    loadCategories();
  
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
</body>
</html>
